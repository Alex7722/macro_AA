---
title: "Topics Description"
author: "Aur√©lien Goutsmedt and Alexandre Truc"
date: "03/12/2021"
output: 
  html_document:
    theme: united
    toc: true
    number_sections: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(kableExtra)
```

```{js zoom-jquery, include = FALSE, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{r cars}
source("Script_paths_and_basic_objects_EER.R")
topics <- readRDS(paste0(data_path, "EER/topic_model_1-60.rds")) %>% 
  pivot_longer(cols = contains("Topic"),
               names_to = "topic_name",
               values_to = "gamma") %>% 
  filter(gamma > 0.05) %>% 
  mutate(ID_Art = as.integer(ID_Art)) %>% 
  select(-abstract) %>% 
  as.data.table()
```

```{r}
ref_topics <- merge(topics, edges_JEL, by = "ID_Art") %>% 
  as.data.table()
ref_topics <- ref_topics[, nb_cit_topic := .N, by = c("topic_name", "New_id2")] %>% 
  .[, nb_cit_european := .N, by = c("topic_name", "New_id2", "Journal_type", "EU_US_collab")] %>% 
  select(New_id2, Nom, Annee, Revue_Abbrege, topic_name, Journal_type, EU_US_collab, nb_cit_topic, nb_cit_european) %>% 
  unique()

cited_corpus <- merge(topics, nodes_JEL[, c("ID_Art","ItemID_Ref")], by = "ID_Art")
edges_JEL[, nb_cit := .N, by = "ItemID_Ref"]
cited_corpus <- merge(cited_corpus, edges_JEL[, c("ItemID_Ref", "nb_cit")], by = "ItemID_Ref") %>% 
  unique()
```

# Details on the different topics

```{r results = "asis"}

for (topic in sort(unique(ref_topics$topic_name))) {
  
refs <- ref_topics[topic_name == topic][, -"topic_name"]
doublons <- which(duplicated(refs$New_id2))
refs <- refs[-doublons]

top_refs <- refs %>% 
  select(- Journal_type, - EU_US_collab) %>% 
  unique() %>% 
  slice_max(order_by = nb_cit_topic, n = 15, with_ties = FALSE)

top_refs_EER_Europeans <- refs %>% 
#  filter(Journal_type == "EER", EU_US_collab == "Europe Only") %>% 
  select(- Journal_type, - EU_US_collab) %>% 
  unique() %>% 
  slice_max(order_by = nb_cit_european, n = 15, with_ties = FALSE)

cited <- cited_corpus[topic_name == topic][, -"topic_name"]
top_cited <- cited %>% 
  select(-document, -gamma, -ItemID_Ref, -ID_Art) %>% 
  unique() %>% 
  slice_max(order_by = nb_cit, n = 15, with_ties = FALSE)

top_cited_EER <- cited %>% 
  filter(Journal_type == "EER") %>% 
  select(-document, -gamma, -ItemID_Ref, -ID_Art, -Journal_type) %>% 
  unique() %>% 
  slice_max(order_by = nb_cit, n = 15, with_ties = FALSE)

################ Beginning of the template ######################
  cat("##","Topic:", topic, "\n")

  cat("###","References:", topic, "\n")
  cat("The most common references:")
  cat("\n\n")
  print(kable(top_refs) %>% 
          kable_styling(bootstrap_options = c("striped", "condensed", full_width = F)))
  cat("\n\n")
  
  cat("The most common refs for Europeans publishing in EER:")
  cat("\n\n")
  print(kable(top_refs_EER_Europeans) %>% 
          kable_styling(bootstrap_options = c("striped", "condensed", full_width = F)))
  cat("\n\n")
 
  cat("###","Popular Articles:", topic, "\n") 
      cat("The most popular articles in the topic:")
  cat("\n\n")
  print(kable(top_cited) %>% 
          kable_styling(bootstrap_options = c("striped", "condensed", full_width = F)))
  cat("\n\n")
  
  cat("The most popular EER articles in the topic:")
  cat("\n\n")
  print(kable(top_cited_EER) %>% 
          kable_styling(bootstrap_options = c("striped", "condensed", full_width = F)))
  cat("\n\n")
}
```

