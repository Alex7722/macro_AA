---
title: "AER"
output: 
  html_document:
    toc: true
    number_sections: true
    toc_float: true
    code_folding: hide
    df_print: paged
---


```{r setup, include=FALSE}
library(knitr)
knitr::opts_knit$set(root.dir = "/projects/data/macro_AA")
library(png)
library(grid)
library(ggnewscale)
library(vite)
library(RMySQL)
library(NetworkToolbox)
library(broom)
library(igraph)
# library(dplyr)
library(data.table)
library(ggplot2)
library(magrittr)
library(tm)
library(tidyr)
library(tidytext)
library('cluster')
library('ggraph')
library('tibble')
library('tidygraph')
library(ggrepel)
library(readr)
library(leiden)
library(ggraph)
library(ggnewscale)
library(remotes)
library(vite)
library("reticulate")
library(reticulate)
library(leiden)
library(tidygraph)
library(rlang)
library(leiden)
library(ggforce)
library(d3Network)
library(scales)
library(RColorBrewer)
require(DescTools)
require(stringr)
library(docstring)
library(quanteda)
library(pander)
library(DT)
require(forcats)
require(tidyverse)
library(sigmajs)

source("/home/alexandre/functions_networks.R")

source("~/macro_AA/logins_DO_NOT_UPLOAD.R")

ESH <- dbConnect(MySQL(), user=usr, password=pswd, dbname='OST_Expanded_SciHum',
                 host='127.0.0.1')
setwd("/projects/data/macro_AA")

######################### Naming communities #########################
name_coup_2 <-  data.table(Leiden1 = "NA", Leiden_num= as.double(1:20))
name_coup_2[Leiden_num==1, Leiden1:="Consumption & Production Functions Estimations"]
name_coup_2[Leiden_num==2, Leiden1:="Disequilibrium Theory"]
name_coup_2[Leiden_num==3, Leiden1:="International Macroeconomics"]
name_coup_2[Leiden_num==4, Leiden1:="Rational Expectations"]
name_coup_2[Leiden_num==5, Leiden1:="Production Function & Investment"]
name_coup_2[Leiden_num==6, Leiden1:="Time Series & Consumption"]
name_coup_2[Leiden_num==7, Leiden1:="Firm Theory"]
name_coup_2[Leiden_num==8, Leiden1:="Micro-analysis of Markets"]



all_names <- rbind(name_coup_2) %>% as.data.table()
all_names <- all_names[Leiden1!="NA"]

n_color <- all_names[,.N]
seed <- brewer.pal(8, name = "Dark2")

######################### The colors of communities #########################
color = data.table(
  Leiden1 = 1:500,
  color = brewer.pal(8, name = "Dark2"))

color[Leiden1>=201, color == rep(brewer.pal(8, name = "Dark2"))]
color[Leiden1>208 & Leiden1<=220, color := brewer.pal(12, name = "Paired")]
color[Leiden1>220 & Leiden1<=228, color := brewer.pal(8, name = "Dark2")]
color[Leiden1>228 & Leiden1<=240, color := brewer.pal(12, name = "Paired")]

color <- color %>%  mutate(Leiden1 = sprintf("%02d", Leiden1)) %>% mutate(Leiden1 = as.character(Leiden1))

color[Leiden1>=201 & Leiden1<201+all_names[,.N,Leiden1][,.N], Leiden1:=all_names[,.N,Leiden1]$Leiden1]

color[Leiden1=="NA", color:="#c1c1c1"]

######################### Disciplines #########################

revues <- fread("all_journals.csv", quote="") %>% data.table
revues[,Code_Discipline:=as.character(Code_Discipline)]
revues[,Code_Revue:=as.character(Code_Revue)]

disciplines  <-  dbGetQuery(ESH, "SELECT ESpecialite, EGrande_Discipline, Code_Discipline FROM OST_Expanded_SciHum.Disciplines;") %>% data.table
disciplines <- disciplines[EGrande_Discipline=="Natural Sciences and Engineering", ESpecialite_custom:="Other NSE"]
disciplines <- disciplines[EGrande_Discipline=="Social Sciences and Humanities", ESpecialite_custom:="Other SSH"]
disciplines <- disciplines[Code_Discipline==132, ESpecialite_custom:= "Management"]
disciplines <- disciplines[Code_Discipline==119, ESpecialite_custom:= "Economics"]
disciplines <- disciplines[Code_Discipline==18, ESpecialite_custom:= "General NSE"]

disciplines <- disciplines[Code_Discipline>=101 & Code_Discipline<=109, ESpecialite_custom:="Psychology"]

# disciplines <- disciplines[Code_Discipline==4, ESpecialite_custom:= "Ecology and ES"]
# disciplines <- disciplines[Code_Discipline==69, ESpecialite_custom:= "Ecology and ES"]

disciplines <- disciplines[Code_Discipline==138, ESpecialite_custom:= "Law"]
disciplines <- disciplines[Code_Discipline==138, ESpecialite_custom:= "History"]


disciplines <- disciplines[Code_Discipline==125, ESpecialite_custom:= "Pol Sci"]

disciplines <- disciplines[Code_Discipline==120, ESpecialite_custom:= "Geography"]

disciplines <- disciplines[Code_Discipline==91, ESpecialite_custom:= "Math and Stat"] # statistics
disciplines <- disciplines[Code_Discipline==88, ESpecialite_custom:= "Math and Stat"]
disciplines <- disciplines[Code_Discipline==89, ESpecialite_custom:= "Math and Stat"]
disciplines <- disciplines[Code_Discipline==90, ESpecialite_custom:= "Math and Stat"]

# disciplines$ESpecialite_custom <- str_wrap(disciplines$ESpecialite_custom, width = 10)

disciplines[,Code_Discipline:=as.character(Code_Discipline)]


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
#### Basic Corpus ####
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Corpus <- fread("EER/Corpus_AER/AER_NODES_XP.csv", quote="") %>% data.table
Corpus[,Id:=as.character(ID_Art)]
Corpus[,ID_Art:=as.character(ID_Art)]
Corpus[,ItemID_Ref:=as.character(ItemID_Ref)]
Corpus[,Code_Revue:=as.character(Code_Revue)]
Corpus[, c("Code_Discipline"):=NULL]

# Document types
Corpus <- Corpus[Code_Document == 1 | Code_Document == 2 | Code_Document == 3 | Code_Document == 6]

# Decades
Corpus <- Corpus[, decade:= cut(Annee_Bibliographique, seq(1910, 2025, 10), right = FALSE, dig.lab = 4)]
Corpus <- Corpus[decade!="NA"]

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
#### Authors ####
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Authors <- fread("EER/Corpus_AER/AER_AUT_XP.csv", quote="") %>% data.table
Authors[,ID_Art:=as.character(ID_Art)]
Authors <- Authors[ID_Art %in% Corpus$ID_Art][,Nom_ISI:=toupper(Nom_ISI)]

# info about sources
Authors <- merge(Authors, Corpus[,.(ID_Art, Annee_Bibliographique, decade)], by = "ID_Art", all.x = TRUE)


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
#### Institutions ####
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
setwd("/projects/data/macro_AA")

UE <- fread("EER/UE.csv") %>% data.table
UE <- fread("EER/Europe_continent.csv") %>% data.table
Institutions <- fread("EER/Corpus_AER/AER_INST_XP.csv", quote="") %>% data.table
# Institutions <- fread("EER/Corpus_AER/AER_INST_XP2.csv", quote="") %>% data.table

Institutions[Pays=="FED-REP-GER", Pays:="GERMANY"]

# Cleaning this wrong info
Institutions[, c("Nom_ISI", "Ordre"):=NULL] # removing useless columns
Institutions <- Institutions[,head(.SD, 1),.(ID_Art,Institution)] #keeping unique institutions by ID_Art (as in BD)
Institutions <- Institutions[Institution!="NULL" | Pays!="NULL" ]
  
Institutions[,ID_Art:=as.character(ID_Art)]
Institutions <- Institutions[ID_Art %in% Corpus$ID_Art]

# info about sources
Institutions <- merge(Institutions, Corpus[,.(ID_Art, Annee_Bibliographique, decade)], by = "ID_Art", all.x = TRUE)

# Identifying europe
Institutions[, Countries_grouped:=Pays]
Institutions[Countries_grouped=="CZECHOSLOVAKIA" | Countries_grouped=="CZECH-REPUBLIC", Countries_grouped:="CZECH REPUBLIC"]

Institutions[Pays %in% toupper(UE$Countries), Countries_grouped:="Europe"]

# Identifying Collaborations
Institutions[,EU:=0][Countries_grouped=="Europe", EU:=1][,EU:=sum(EU),ID_Art]
Institutions[,US:=0][Countries_grouped=="USA", US:=1][,US:=sum(US),ID_Art]
Institutions[EU>=1 & US>=1, EU_US_collab:= "Collaboration", ID_Art]
Institutions[EU==0 & US>=1, EU_US_collab:= "USA Only", ID_Art]
Institutions[EU>=1 & US==0, EU_US_collab:= "Europe Only", ID_Art]
Institutions[EU==0 & US==0, EU_US_collab:= "Neither", ID_Art]


bridges_collab <- Institutions[EU_US_collab== "Collaboration"][,list(Target = rep(Institution[1:(length(Institution)-1)],(length(Institution)-1):1),
                       Source = rev(Institution)[sequence((length(Institution)-1):1)]),
                 by= ID_Art]
bridges_collab <- bridges_collab[Source > Target, c("Target", "Source") := list(Source, Target)] # exchanging
bridges_collab[,.N,.(Target,Source)][order(-N)] %>% top_n(20)

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
#### Labels, Journals and Disciplines ####
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
#label
Corpus <- merge(Corpus, Authors[Ordre==1, .(Nom_ISI, ID_Art)], by = "ID_Art", all.x = TRUE)
Corpus <- Corpus[, name_short:=  gsub("-.*","",Nom_ISI)]
Corpus$name_short <- toupper(Corpus$name_short)
Corpus <- Corpus[,Label:=paste0(name_short,",",Annee_Bibliographique)]
Corpus[, c("name_short"):=NULL]



#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
#### Corpus Final ####
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Corpus <- merge(Corpus, revues[,.(Code_Revue, Revue)], by="Code_Revue", all.x = TRUE)

```

# Corpus

## Exploring the Corpus

```{r, message=FALSE, warning=FALSE, error=FALSE, results=TRUE, cache=FALSE}

datatable(Corpus, rownames = FALSE, class = 'cell-border stripe')

```

## Distribution of Corpus

```{r, message=FALSE, warning=FALSE, error=FALSE, results=TRUE, cache=FALSE}
ggplot(Corpus, aes(as.numeric(Annee_Bibliographique))) + 
  geom_bar()

```

## Most Productive authors

```{r, message=FALSE, warning=FALSE, error=FALSE, results=TRUE, cache=FALSE}
Authors[,.N,Nom_ISI][order(-N)] %>% top_n(20)
```

## Most Productive Institutions and Countries

```{r, message=FALSE, warning=FALSE, error=FALSE, results=TRUE, cache=FALSE}
Institutions[,.N,Pays][order(-N)] %>% top_n(20)
Institutions[,.N,Institution][order(-N)] %>% top_n(20)
```

```{r, message=FALSE, warning=FALSE, error=FALSE, results=TRUE, cache=FALSE}
Institutions[,.N,Pays][order(-N)] %>% top_n(20)

count_year <- Institutions[,n_inst_tot:=.N, Pays][order(-n_inst_tot)]
count_year <- count_year[n_inst_tot<300, Pays:="OTHER"]
count_year <- count_year[, nb_aut_country:=.N, .(Annee_Bibliographique, Pays)]


ggplot(count_year, aes(Annee_Bibliographique, after_stat(count), fill = fct_rev(fct_infreq(Pays)))) +
  geom_density(position = "fill") +
  labs(fill = "Countries (Top 7)") +
  scale_x_continuous("Years") +
  scale_y_continuous("Countries Identified by Unique Institution by Paper") +
  theme_classic() +
  scale_fill_manual(values = c(rev(brewer.pal(n = 9, name = "Paired")))) 
  # ggsave("Graphs/country_time_stacked.png", scale = 1)

count_year <- Institutions[,n_inst_tot:=.N, Countries_grouped][order(-n_inst_tot)]
count_year <- count_year[n_inst_tot<300, Countries_grouped:="OTHER"]
count_year <- count_year[, nb_aut_country:=.N, .(Annee_Bibliographique, Countries_grouped)]


ggplot(count_year, aes(Annee_Bibliographique, after_stat(count), fill = fct_rev(fct_infreq(Countries_grouped)))) +
  geom_density(position = "fill") +
  labs(fill = "Countries (Grouped)") +
  scale_x_continuous("Years") +
  scale_y_continuous("Countries Identified by Unique Institution by Paper") +
  theme_classic() +
  scale_fill_manual(values = c(rev(brewer.pal(n = 9, name = "Paired")))) 
  # ggsave("Graphs/country_time_stacked.png", scale = 1)

count_year <- Institutions[,n_inst_tot:=.N, Countries_grouped][order(-n_inst_tot)]
count_year <- count_year[n_inst_tot<300, Countries_grouped:="OTHER"]
count_year <- count_year %>% group_by(Annee_Bibliographique, Countries_grouped) %>% summarise(n = n()) %>%  mutate(freq = n / sum(n)) %>% as.data.table()

ggplot(count_year, aes(x=Annee_Bibliographique, y=freq, group=Countries_grouped, color=Countries_grouped)) +
  geom_smooth(method="auto", se=FALSE, fullrange=FALSE, level=0.95, span = 0.4) +
  geom_point() +
  labs(fill = "Countries") +
  scale_x_continuous("Years") +
  scale_y_continuous("Countries Identified by Unique Institution by Paper") +
  theme_minimal() +
  scale_fill_manual(values = c(rev(brewer.pal(n = 9, name = "Paired")))) +
  scale_color_discrete(guide = FALSE) +
  geom_label_repel(aes(label = Countries_grouped), data = count_year[Annee_Bibliographique==2019], nudge_x = 1, segment.color = NA) +
  coord_cartesian(xlim = c(NA, 2022)) 
  # ggsave("Graphs/country_time_stacked.png", scale = 1)


count_year <- Institutions[, head(.SD, 1), .(ID_Art)][Annee_Bibliographique>=1974]
count_year <- count_year %>% group_by(Annee_Bibliographique, EU_US_collab) %>% summarise(n = n()) %>%  mutate(freq = n / sum(n)) %>% as.data.table()

ggplot(count_year, aes(x=Annee_Bibliographique, y=freq, group=EU_US_collab, color=EU_US_collab)) +
  geom_smooth(method="auto", se=FALSE, fullrange=FALSE, level=0.95, span = 0.3) +
  geom_point() +
  labs(fill = "Countries (Top 7)") +
  scale_x_continuous("Years") +
  scale_y_continuous("Collaborations Europe/USA Within Papers") +
  theme_minimal() +
  scale_fill_manual(values = c(rev(brewer.pal(n = 9, name = "Paired")))) +
  scale_color_discrete(guide = FALSE) +
  geom_label_repel(aes(label = EU_US_collab), data = count_year[Annee_Bibliographique==2019], nudge_x = 1, segment.color = NA) +
  coord_cartesian(xlim = c(NA, 2022)) 
  # ggsave("Graphs/country_time_stacked.png", scale = 1)
```

## Most Important Journals

```{r, message=FALSE, warning=FALSE, error=FALSE, results=TRUE, cache=FALSE}
Corpus[,.N, Revue][order(-N)]
```

# A Look at References

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
refs <- fread("EER/Corpus_AER/AER_REFS_XP.csv", quote="") %>% data.table 
refs <- refs[ID_Art_Source %in% Corpus$ID_Art]

refs[,ID_Art_Source:=as.character(ID_Art_Source)]
refs[,Id:=as.character(ItemID_Ref_Target)]
refs[,Annee_Bibliographique_Target:=Annee]
refs[,Nom_Target:=Nom]
refs[,Code_Revue:=as.character(Code_Revue)]
refs[,Code_Discipline:=as.character(Code_Discipline)]

# Label column
refs <- refs[, name_short:=  gsub("-.*","",Nom)]
refs$name_short <- toupper(refs$name_short)
refs <- refs[,Label_Target:=paste0(name_short,",",Annee_Bibliographique_Target)]
refs[, c("name_short"):=NULL]

# Disciplines and journals
refs <- merge(refs, revues[,.(Code_Revue, Revue)], by="Code_Revue", all.x = TRUE)
refs[,Revue := sub("\r","", Revue)]
refs <- merge(refs, disciplines, by="Code_Discipline", all.x = TRUE)

# Info about Sources
refs[,nb_cit:=.N,ItemID_Ref_Target]

# Info about Sources
refs <- merge(refs, Corpus[,.(ID_Art, Annee_Bibliographique, decade)], by.x = "ID_Art_Source", by.y = "ID_Art", all.x = TRUE)
refs[, c("ID_Art"):=NULL]
setnames(refs, "Annee_Bibliographique", "Annee_Bibliographique_Source")

refs[,.(ID_Art_Source, ItemID_Ref_Target, Code_Discipline, ESpecialite, ESpecialite_custom, Annee_Bibliographique_Target, Nom_Target, Label_Target, nb_cit)]

```

## Top Disciplines

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
refs[,.N, ESpecialite][order(-N)]

```

## Top Journals

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
refs[,.N, Revue][order(-N)]
refs[,.N, .(decade,Revue)][order(-decade,-N)][, head(.SD, 3), .(decade)][is.na(Revue)==FALSE]
```

## Top References

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
refs[ItemID_Ref_Target!="NULL"][order(-nb_cit)][, head(.SD, 1), .(Label_Target)][,.(Label_Target,nb_cit)] %>% top_n(50)

```

## Top References by disciplines

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
refs[ItemID_Ref_Target!="NULL"][order(-nb_cit)][, head(.SD, 1), .(Label_Target, ESpecialite_custom)][order(ESpecialite_custom), head(.SD, 5), .(ESpecialite_custom)][,.(ESpecialite_custom, Label_Target, nb_cit)]

```

## Share of Economics and Management in References Over Time

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
eco_ref_year <- refs[complete.cases(ESpecialite_custom)==TRUE][ESpecialite_custom=="Economics" | ESpecialite_custom=="Management", .N, .(Annee_Bibliographique_Source)]
setnames(eco_ref_year,"N", "n_eco_ref")

n_ref <- refs[complete.cases(ESpecialite_custom)==TRUE,.N, Annee_Bibliographique_Source]
setnames(n_ref,"N", "n_ref_year")

eco_ref_year <- merge(eco_ref_year, n_ref, by = "Annee_Bibliographique_Source")
# eco_ref_year <- eco_ref_year[,share_years_mean:=frollmean(n_eco_ref/n_ref_year, 3)]


ggplot(eco_ref_year, aes(x=Annee_Bibliographique_Source, y=n_eco_ref/n_ref_year)) +
  geom_smooth(method="auto", se=FALSE, fullrange=FALSE, level=0.95, span = 0.4)+
  geom_point()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Years") +
  scale_y_continuous("Share of Economics and Management in References") +
  coord_cartesian(ylim = c(NA,NA)) 
  # ggsave("Graphs/coc.png", scale = 1)



```

## Share of Other Disciplines in References Over Time

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
disc_ref_year <- refs[, .N, .(Annee_Bibliographique_Source, ESpecialite_custom)]
disc_ref_year <- disc_ref_year[complete.cases(ESpecialite_custom)==TRUE]
disc_ref_year <- complete(disc_ref_year, ESpecialite_custom, Annee_Bibliographique_Source) %>% as.data.table
disc_ref_year <- disc_ref_year[is.na(N), N:=0]
setnames(disc_ref_year,"N", "nb_cit_disc")

n_ref <- refs[complete.cases(ESpecialite_custom)==TRUE,.N, Annee_Bibliographique_Source]
disc_ref_year <- merge(disc_ref_year, n_ref, by = "Annee_Bibliographique_Source")
setnames(disc_ref_year,"N", "n_ref_year")

disc_ref_year <- disc_ref_year[,share_years_mean:=frollmean(nb_cit_disc/n_ref_year, 3), ESpecialite_custom]


ggplot(disc_ref_year[ESpecialite_custom!="Economics" & ESpecialite_custom!="Management"], aes(x=Annee_Bibliographique_Source, y=share_years_mean, group=ESpecialite_custom, color=ESpecialite_custom)) +
  geom_smooth(method="auto", se=FALSE, fullrange=FALSE, level=0.95, span = 0.4)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Years") +
  scale_y_continuous("Share of Disciplines in References") +
  coord_cartesian(ylim = c(0,NA), xlim = c(NA, 2022)) +
  scale_color_discrete(guide = FALSE) +
  geom_label_repel(aes(label = ESpecialite_custom), data = disc_ref_year[ESpecialite_custom!="Economics" & ESpecialite_custom!="Management"][Annee_Bibliographique_Source==2019], nudge_x = 1, segment.color = NA) 
  # ggsave("Graphs/disc_ref_time.png", scale = 1)

ggplot(disc_ref_year[ESpecialite_custom!="Economics" & ESpecialite_custom!="Management"], aes(x=Annee_Bibliographique_Source, y=share_years_mean, group=ESpecialite_custom, color=ESpecialite_custom)) +
  geom_smooth(method="auto", se=FALSE, fullrange=FALSE, level=0.95, span = 0.4)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Years") +
  scale_y_continuous("Share of Disciplines in References") +
  coord_cartesian(ylim = c(0,0.04), xlim = c(NA, 2022)) +
  scale_color_discrete(guide = FALSE) +
  geom_label_repel(aes(label = ESpecialite_custom), data = disc_ref_year[ESpecialite_custom!="Economics" & ESpecialite_custom!="Management"][Annee_Bibliographique_Source==2019], nudge_x = 1, segment.color = NA) 
  # ggsave("Graphs/disc_ref_time.png", scale = 1)

                   
```

# Networks

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}

make_into_coupling_tbl <- function(nodes, edges, time_window_variable, time_window, weight_treshold_value=1)
{  
  #' function for edges of bibliographic coupling
  #' 
  #' This function creates the cosine normalized edges of the bibliographic coupling network, from a direct
  #' citation data frame.
  #' 
  #' @param dt
  #' The table with citing and cited documents.
  
  nb_cit <- Edges[decade==time_window, .N, ItemID_Ref_Target]
  
  colnames(nb_cit)[colnames(nb_cit) == "N"] <- "size"
  
  Edges_coupling <- coupling_strength_bibliographic_coupling(Edges[decade==time_window], "ID_Art_Source", "ItemID_Ref_Target", 
                                            normalized_weight_only = TRUE, weight_threshold = weight_treshold_value, output_in_character = TRUE)
  
  Nodes_coupling <- Nodes_coupling[ID_Art %in% Edges_coupling$from | ID_Art %in% Edges_coupling$to]
  
  Nodes_coupling <- merge(Nodes_coupling, nb_cit, by.x = "ItemID_Ref", by.y = "ItemID_Ref_Target", all.x = TRUE)
  
  Nodes_coupling[is.na(size),size:=0]
  
  tbl <- tbl_graph(nodes = Nodes_coupling, edges = Edges_coupling, directed = FALSE, node_key = "Id")

  return (tbl)

}

```

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
######################### Nodes Coupling **********************
Nodes_coupling <- Corpus[Annee_Bibliographique>=1950]
Nodes_coupling[,.N,decade]
######################### Nodes Cocit **********************
Nodes_cocit <- refs
Nodes_cocit %>%  rename(Label = Label_Target)

######################### Direct Citation Edges **********************
Edges <- refs[Annee_Bibliographique_Source>=1950]
Edges[,ID_Art_Source:=as.character(ID_Art_Source)]
Edges <- Edges[ItemID_Ref_Target!="NULL",.(ID_Art_Source, ItemID_Ref_Target, decade)]

setkey(Nodes_coupling, Annee_Bibliographique)
Nodes_coupling <- Nodes_coupling[order(Annee_Bibliographique)]

setkey(Nodes_cocit, Annee_Bibliographique_Source)
Nodes_cocit <- Nodes_cocit[order(Annee_Bibliographique_Source)]

setkey(Edges, decade)
Edges <- Edges[order(decade)]

tbl_coup_list <- list()
for (variable_time_window in Nodes_coupling[,.N,decade]$decade) {
tbl_coup_list[[variable_time_window]] <- make_into_coupling_tbl(Nodes_coupling, Edges, decade, variable_time_window)
}



```



## Coupling `r names(tbl_coup_list[1])`

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
set.seed(2000)
source("/home/alexandre/functions_networks.R")

tbl_list <- make_a_graph(tbl_coup_list[[1]], color, 1, "RBConfigurationVertexPartition", treshold_color=0.1, 0.02,layout_graph = "TRUE", 10000,2000)
tbl_list$components

tbl <- tbl_list$tbl

label_com <- tbl %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 
  # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm")

tbl_sec <- tbl_list$tbl_sec

label_com <- tbl_sec %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl_sec, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 


```

### tf-idf 1970

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
tf_idf_results <- tf_idf(tbl, color, 10, 4, 0.1)
tf_idf_results$plot
```

### Overview of Communities

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}

tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1]

most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1]

most_cited_refs <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_refs <- merge(most_cited_refs[,.(ID_Art, Leiden1)], refs[,.(ID_Art_Source, Label_Target, ItemID_Ref_Target)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_refs <- most_cited_refs[ItemID_Ref_Target!="NULL"]
most_cited_refs <- most_cited_refs[,n_cit_ref:=.N, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,n_tot_com:=.N, .(Leiden1)]
most_cited_refs <- most_cited_refs[,share:=n_cit_ref/n_tot_com*100, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 1), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 5), Leiden1]
most_cited_refs <- most_cited_refs[,n_cit_ref_with_share := paste0(Label_Target,"(", round(share),"%",")"), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,.(Most_Cited_Refs = toString(n_cit_ref_with_share)), Leiden1]

most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_disc <- merge(most_cited_disc, refs[,.(ID_Art_Source, ESpecialite_custom)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"]
most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)]
most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 1), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 5), Leiden1]
most_cited_disc <- most_cited_disc[,disc_with_share := paste0(ESpecialite_custom,"(", round(share),"%",")"), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1]

most_prod_journal <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_journal <- most_prod_journal[,.N, .(Leiden1, Revue)][order(-N), head(.SD, 5), Leiden1][,  .(Most_Productive_Journals = toString(Revue)), Leiden1]

most_prod_author <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_author <- merge(most_prod_author, Authors[,.(ID_Art, Nom_ISI)], by = "ID_Art")
most_prod_author <- most_prod_author[,n_cit_aut:=.N, .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 1), .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 5), Leiden1]
most_prod_author <- most_prod_author[,.(Most_Productive_Authors = toString(Nom_ISI.y)), Leiden1]

most_prod_institutions <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_institutions <- merge(most_prod_institutions, Institutions[,.(ID_Art, Institution)], by = "ID_Art")
most_prod_institutions <- most_prod_institutions[Institution!="NULL"]
most_prod_institutions <- most_prod_institutions[,n_cit_inst:=.N, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,n_tot_com:=.N, .(Leiden1)]
most_prod_institutions <- most_prod_institutions[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 1), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 5), Leiden1]
most_prod_institutions <- most_prod_institutions[,inst_with_share := paste0(Institution,"(", round(share),"%",")"), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,.(Most_Productive_Institutions = toString(inst_with_share)), Leiden1]

collaborations <- tbl %>% activate(nodes) %>% as.data.table()
collaborations <- merge(collaborations, Institutions[,.(ID_Art, EU_US_collab)], by = "ID_Art")
collaborations <- collaborations[EU_US_collab!="NULL"]
collaborations <- collaborations[,n_cit_inst:=.N, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,n_tot_com:=.N, .(Leiden1)]
collaborations <- collaborations[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 1), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 5), Leiden1]
collaborations <- collaborations[,inst_with_share := paste0(EU_US_collab,"(", round(share),"%",")"), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,.(Collaborations = toString(inst_with_share)), Leiden1]

most_prod_countries <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_countries <- merge(most_prod_countries, Institutions[,.(ID_Art, Pays)], by = "ID_Art")
most_prod_countries <- most_prod_countries[Pays!="NULL"]
most_prod_countries <- most_prod_countries[,n_cit_count:=.N, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,n_tot_com:=.N, .(Leiden1)]
most_prod_countries <- most_prod_countries[,share:=n_cit_count/n_tot_com*100, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 1), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 5), Leiden1]
most_prod_countries <- most_prod_countries[,count_with_share := paste0(Pays,"(", round(share),"%",")"), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,.(Most_Productive_Countries = toString(count_with_share)), Leiden1]

summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_refs, most_cited_disc, most_prod_journal, most_prod_author, most_prod_institutions, most_prod_countries, collaborations))


pander(summary)

```





## Coupling `r names(tbl_coup_list[2])`

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
set.seed(2000)
source("/home/alexandre/functions_networks.R")

tbl_list <- make_a_graph(tbl_coup_list[[2]], color, 1, "RBConfigurationVertexPartition", treshold_color=0.05, 0.02, layout_graph = "TRUE", 10000,2000, name_leiden = name_coup_2)
tbl_list$components

tbl <- tbl_list$tbl

label_com <- tbl %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(betweenness)][, head(.SD, 1), Leiden1]
label_com$Leiden1 <- str_wrap(label_com$Leiden1, width = 20)
label_com[Leiden_num==6, x:=x-200][Leiden_num==6, y:=y-100]
label_com[Leiden_num==2, x:=x-300][Leiden_num==2, y:=y-100]
label_com[Leiden_num==3, x:=x][Leiden_num==3, y:=y-150]
label_com[Leiden_num==4, x:=x+150][Leiden_num==4, y:=y+100]
label_com[Leiden_num==1, x:=x+150][Leiden_num==1, y:=y+50]


ggraph(tbl, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = paste0(Leiden_num, "-", as.character(Leiden1)), size = 0.5, fill = color), alpha = 0.9, vjust=1) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 
  # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm")

tbl_sec <- tbl_list$tbl_sec

label_com <- tbl_sec %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 1), Leiden1]

ggraph(tbl_sec, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Leiden1), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity()



```

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
source("/home/alexandre/functions_networks.R")
library(sigmajs)

sigma_it(tbl)
```

### tf-idf

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
tf_idf_results <- tf_idf(tbl, color, 10, 4, 0.05)
tf_idf_results$plot
```

### Overview of Communities

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}

tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1]

most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1]

most_cited_refs <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_refs <- merge(most_cited_refs[,.(ID_Art, Leiden1)], refs[,.(ID_Art_Source, Label_Target, ItemID_Ref_Target)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_refs <- most_cited_refs[ItemID_Ref_Target!="NULL"]
most_cited_refs <- most_cited_refs[,n_cit_ref:=.N, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,n_tot_com:=.N, .(Leiden1)]
most_cited_refs <- most_cited_refs[,share:=n_cit_ref/n_tot_com*100, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 1), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 5), Leiden1]
most_cited_refs <- most_cited_refs[,n_cit_ref_with_share := paste0(Label_Target,"(", round(share),"%",")"), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,.(Most_Cited_Refs = toString(n_cit_ref_with_share)), Leiden1]

most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_disc <- merge(most_cited_disc, refs[,.(ID_Art_Source, ESpecialite_custom)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"]
most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)]
most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 1), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 5), Leiden1]
most_cited_disc <- most_cited_disc[,disc_with_share := paste0(ESpecialite_custom,"(", round(share),"%",")"), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1]

most_prod_journal <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_journal <- most_prod_journal[,.N, .(Leiden1, Revue)][order(-N), head(.SD, 5), Leiden1][,  .(Most_Productive_Journals = toString(Revue)), Leiden1]

most_prod_author <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_author <- merge(most_prod_author, Authors[,.(ID_Art, Nom_ISI)], by = "ID_Art")
most_prod_author <- most_prod_author[,n_cit_aut:=.N, .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 1), .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 5), Leiden1]
most_prod_author <- most_prod_author[,.(Most_Productive_Authors = toString(Nom_ISI.y)), Leiden1]

most_prod_institutions <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_institutions <- merge(most_prod_institutions, Institutions[,.(ID_Art, Institution)], by = "ID_Art")
most_prod_institutions <- most_prod_institutions[Institution!="NULL"]
most_prod_institutions <- most_prod_institutions[,n_cit_inst:=.N, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,n_tot_com:=.N, .(Leiden1)]
most_prod_institutions <- most_prod_institutions[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 1), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 5), Leiden1]
most_prod_institutions <- most_prod_institutions[,inst_with_share := paste0(Institution,"(", round(share),"%",")"), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,.(Most_Productive_Institutions = toString(inst_with_share)), Leiden1]

collaborations <- tbl %>% activate(nodes) %>% as.data.table()
collaborations <- merge(collaborations, Institutions[,.(ID_Art, EU_US_collab)], by = "ID_Art")
collaborations <- collaborations[EU_US_collab!="NULL"]
collaborations <- collaborations[,n_cit_inst:=.N, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,n_tot_com:=.N, .(Leiden1)]
collaborations <- collaborations[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 1), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 5), Leiden1]
collaborations <- collaborations[,inst_with_share := paste0(EU_US_collab,"(", round(share),"%",")"), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,.(Collaborations = toString(inst_with_share)), Leiden1]

most_prod_countries <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_countries <- merge(most_prod_countries, Institutions[,.(ID_Art, Pays)], by = "ID_Art")
most_prod_countries <- most_prod_countries[Pays!="NULL"]
most_prod_countries <- most_prod_countries[,n_cit_count:=.N, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,n_tot_com:=.N, .(Leiden1)]
most_prod_countries <- most_prod_countries[,share:=n_cit_count/n_tot_com*100, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 1), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 5), Leiden1]
most_prod_countries <- most_prod_countries[,count_with_share := paste0(Pays,"(", round(share),"%",")"), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,.(Most_Productive_Countries = toString(count_with_share)), Leiden1]

summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_refs, most_cited_disc, most_prod_journal, most_prod_author, most_prod_institutions, most_prod_countries, collaborations))


pander(summary)

```


## Coupling `r names(tbl_coup_list[3])`

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
set.seed(2000)
source("/home/alexandre/functions_networks.R")

tbl_list <- make_a_graph(tbl_coup_list[[3]], color, 1, "RBConfigurationVertexPartition", treshold_color=0.05, 0.02, layout_graph = "TRUE", 10000,2000)
tbl_list$components

tbl <- tbl_list$tbl

label_com <- tbl %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 
  # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm")

tbl_sec <- tbl_list$tbl_sec

label_com <- tbl_sec %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl_sec, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 


```

### tf-idf

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
tf_idf_results <- tf_idf(tbl, color, 10, 4, 0.05)
tf_idf_results$plot
```

### Overview of Communities

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}

tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1]

most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1]

most_cited_refs <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_refs <- merge(most_cited_refs[,.(ID_Art, Leiden1)], refs[,.(ID_Art_Source, Label_Target, ItemID_Ref_Target)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_refs <- most_cited_refs[ItemID_Ref_Target!="NULL"]
most_cited_refs <- most_cited_refs[,n_cit_ref:=.N, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,n_tot_com:=.N, .(Leiden1)]
most_cited_refs <- most_cited_refs[,share:=n_cit_ref/n_tot_com*100, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 1), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 5), Leiden1]
most_cited_refs <- most_cited_refs[,n_cit_ref_with_share := paste0(Label_Target,"(", round(share),"%",")"), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,.(Most_Cited_Refs = toString(n_cit_ref_with_share)), Leiden1]

most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_disc <- merge(most_cited_disc, refs[,.(ID_Art_Source, ESpecialite_custom)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"]
most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)]
most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 1), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 5), Leiden1]
most_cited_disc <- most_cited_disc[,disc_with_share := paste0(ESpecialite_custom,"(", round(share),"%",")"), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1]

most_prod_journal <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_journal <- most_prod_journal[,.N, .(Leiden1, Revue)][order(-N), head(.SD, 5), Leiden1][,  .(Most_Productive_Journals = toString(Revue)), Leiden1]

most_prod_author <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_author <- merge(most_prod_author, Authors[,.(ID_Art, Nom_ISI)], by = "ID_Art")
most_prod_author <- most_prod_author[,n_cit_aut:=.N, .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 1), .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 5), Leiden1]
most_prod_author <- most_prod_author[,.(Most_Productive_Authors = toString(Nom_ISI.y)), Leiden1]

most_prod_institutions <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_institutions <- merge(most_prod_institutions, Institutions[,.(ID_Art, Institution)], by = "ID_Art")
most_prod_institutions <- most_prod_institutions[Institution!="NULL"]
most_prod_institutions <- most_prod_institutions[,n_cit_inst:=.N, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,n_tot_com:=.N, .(Leiden1)]
most_prod_institutions <- most_prod_institutions[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 1), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 5), Leiden1]
most_prod_institutions <- most_prod_institutions[,inst_with_share := paste0(Institution,"(", round(share),"%",")"), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,.(Most_Productive_Institutions = toString(inst_with_share)), Leiden1]

collaborations <- tbl %>% activate(nodes) %>% as.data.table()
collaborations <- merge(collaborations, Institutions[,.(ID_Art, EU_US_collab)], by = "ID_Art")
collaborations <- collaborations[EU_US_collab!="NULL"]
collaborations <- collaborations[,n_cit_inst:=.N, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,n_tot_com:=.N, .(Leiden1)]
collaborations <- collaborations[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 1), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 5), Leiden1]
collaborations <- collaborations[,inst_with_share := paste0(EU_US_collab,"(", round(share),"%",")"), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,.(Collaborations = toString(inst_with_share)), Leiden1]

most_prod_countries <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_countries <- merge(most_prod_countries, Institutions[,.(ID_Art, Pays)], by = "ID_Art")
most_prod_countries <- most_prod_countries[Pays!="NULL"]
most_prod_countries <- most_prod_countries[,n_cit_count:=.N, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,n_tot_com:=.N, .(Leiden1)]
most_prod_countries <- most_prod_countries[,share:=n_cit_count/n_tot_com*100, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 1), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 5), Leiden1]
most_prod_countries <- most_prod_countries[,count_with_share := paste0(Pays,"(", round(share),"%",")"), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,.(Most_Productive_Countries = toString(count_with_share)), Leiden1]

summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_refs, most_cited_disc, most_prod_journal, most_prod_author, most_prod_institutions, most_prod_countries, collaborations))


pander(summary)

```


## Coupling `r names(tbl_coup_list[4])`

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
set.seed(2000)
source("/home/alexandre/functions_networks.R")

tbl_list <- make_a_graph(tbl_coup_list[[4]], color, 1, "RBConfigurationVertexPartition", treshold_color=0.05, 0.02, layout_graph = "TRUE", 10000,2000)
tbl_list$components

tbl <- tbl_list$tbl

label_com <- tbl %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 
  # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm")

tbl_sec <- tbl_list$tbl_sec

label_com <- tbl_sec %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl_sec, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 


```

### tf-idf

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
tf_idf_results <- tf_idf(tbl, color, 10, 4)
tf_idf_results$plot
```

### Overview of Communities

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}

tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1]

most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1]

most_cited_refs <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_refs <- merge(most_cited_refs[,.(ID_Art, Leiden1)], refs[,.(ID_Art_Source, Label_Target, ItemID_Ref_Target)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_refs <- most_cited_refs[ItemID_Ref_Target!="NULL"]
most_cited_refs <- most_cited_refs[,n_cit_ref:=.N, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,n_tot_com:=.N, .(Leiden1)]
most_cited_refs <- most_cited_refs[,share:=n_cit_ref/n_tot_com*100, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 1), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 5), Leiden1]
most_cited_refs <- most_cited_refs[,n_cit_ref_with_share := paste0(Label_Target,"(", round(share),"%",")"), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,.(Most_Cited_Refs = toString(n_cit_ref_with_share)), Leiden1]

most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_disc <- merge(most_cited_disc, refs[,.(ID_Art_Source, ESpecialite_custom)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"]
most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)]
most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 1), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 5), Leiden1]
most_cited_disc <- most_cited_disc[,disc_with_share := paste0(ESpecialite_custom,"(", round(share),"%",")"), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1]

most_prod_journal <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_journal <- most_prod_journal[,.N, .(Leiden1, Revue)][order(-N), head(.SD, 5), Leiden1][,  .(Most_Productive_Journals = toString(Revue)), Leiden1]

most_prod_author <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_author <- merge(most_prod_author, Authors[,.(ID_Art, Nom_ISI)], by = "ID_Art")
most_prod_author <- most_prod_author[,n_cit_aut:=.N, .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 1), .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 5), Leiden1]
most_prod_author <- most_prod_author[,.(Most_Productive_Authors = toString(Nom_ISI.y)), Leiden1]

most_prod_institutions <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_institutions <- merge(most_prod_institutions, Institutions[,.(ID_Art, Institution)], by = "ID_Art")
most_prod_institutions <- most_prod_institutions[Institution!="NULL"]
most_prod_institutions <- most_prod_institutions[,n_cit_inst:=.N, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,n_tot_com:=.N, .(Leiden1)]
most_prod_institutions <- most_prod_institutions[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 1), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 5), Leiden1]
most_prod_institutions <- most_prod_institutions[,inst_with_share := paste0(Institution,"(", round(share),"%",")"), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,.(Most_Productive_Institutions = toString(inst_with_share)), Leiden1]

collaborations <- tbl %>% activate(nodes) %>% as.data.table()
collaborations <- merge(collaborations, Institutions[,.(ID_Art, EU_US_collab)], by = "ID_Art")
collaborations <- collaborations[EU_US_collab!="NULL"]
collaborations <- collaborations[,n_cit_inst:=.N, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,n_tot_com:=.N, .(Leiden1)]
collaborations <- collaborations[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 1), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 5), Leiden1]
collaborations <- collaborations[,inst_with_share := paste0(EU_US_collab,"(", round(share),"%",")"), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,.(Collaborations = toString(inst_with_share)), Leiden1]

most_prod_countries <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_countries <- merge(most_prod_countries, Institutions[,.(ID_Art, Pays)], by = "ID_Art")
most_prod_countries <- most_prod_countries[Pays!="NULL"]
most_prod_countries <- most_prod_countries[,n_cit_count:=.N, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,n_tot_com:=.N, .(Leiden1)]
most_prod_countries <- most_prod_countries[,share:=n_cit_count/n_tot_com*100, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 1), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 5), Leiden1]
most_prod_countries <- most_prod_countries[,count_with_share := paste0(Pays,"(", round(share),"%",")"), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,.(Most_Productive_Countries = toString(count_with_share)), Leiden1]

summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_refs, most_cited_disc, most_prod_journal, most_prod_author, most_prod_institutions, most_prod_countries, collaborations))


pander(summary)
```


## Coupling `r names(tbl_coup_list[5])`

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
set.seed(2000)


tbl_list <- make_a_graph(tbl_coup_list[[5]], color, 1, "RBConfigurationVertexPartition", treshold_color=0.1, 0.02, layout_graph = "TRUE", 10000,2000)
tbl_list$components
tbl <- tbl_list$tbl

label_com <- tbl %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 
  # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm")

tbl_sec <- tbl_list$tbl_sec

label_com <- tbl_sec %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl_sec, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 

```

### tf-idf

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
source("/home/alexandre/functions_networks.R")


tf_idf_results <- tf_idf(tbl, color, 10, 4)
tf_idf_results$plot


```

### Overview of Communities

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}

tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1]

most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1]

most_cited_refs <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_refs <- merge(most_cited_refs[,.(ID_Art, Leiden1)], refs[,.(ID_Art_Source, Label_Target, ItemID_Ref_Target)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_refs <- most_cited_refs[ItemID_Ref_Target!="NULL"]
most_cited_refs <- most_cited_refs[,n_cit_ref:=.N, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,n_tot_com:=.N, .(Leiden1)]
most_cited_refs <- most_cited_refs[,share:=n_cit_ref/n_tot_com*100, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 1), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 5), Leiden1]
most_cited_refs <- most_cited_refs[,n_cit_ref_with_share := paste0(Label_Target,"(", round(share),"%",")"), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,.(Most_Cited_Refs = toString(n_cit_ref_with_share)), Leiden1]

most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_disc <- merge(most_cited_disc, refs[,.(ID_Art_Source, ESpecialite_custom)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"]
most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)]
most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 1), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 5), Leiden1]
most_cited_disc <- most_cited_disc[,disc_with_share := paste0(ESpecialite_custom,"(", round(share),"%",")"), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1]

most_prod_journal <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_journal <- most_prod_journal[,.N, .(Leiden1, Revue)][order(-N), head(.SD, 5), Leiden1][,  .(Most_Productive_Journals = toString(Revue)), Leiden1]

most_prod_author <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_author <- merge(most_prod_author, Authors[,.(ID_Art, Nom_ISI)], by = "ID_Art")
most_prod_author <- most_prod_author[,n_cit_aut:=.N, .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 1), .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 5), Leiden1]
most_prod_author <- most_prod_author[,.(Most_Productive_Authors = toString(Nom_ISI.y)), Leiden1]

most_prod_institutions <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_institutions <- merge(most_prod_institutions, Institutions[,.(ID_Art, Institution)], by = "ID_Art")
most_prod_institutions <- most_prod_institutions[Institution!="NULL"]
most_prod_institutions <- most_prod_institutions[,n_cit_inst:=.N, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,n_tot_com:=.N, .(Leiden1)]
most_prod_institutions <- most_prod_institutions[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 1), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 5), Leiden1]
most_prod_institutions <- most_prod_institutions[,inst_with_share := paste0(Institution,"(", round(share),"%",")"), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,.(Most_Productive_Institutions = toString(inst_with_share)), Leiden1]

collaborations <- tbl %>% activate(nodes) %>% as.data.table()
collaborations <- merge(collaborations, Institutions[,.(ID_Art, EU_US_collab)], by = "ID_Art")
collaborations <- collaborations[EU_US_collab!="NULL"]
collaborations <- collaborations[,n_cit_inst:=.N, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,n_tot_com:=.N, .(Leiden1)]
collaborations <- collaborations[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 1), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 5), Leiden1]
collaborations <- collaborations[,inst_with_share := paste0(EU_US_collab,"(", round(share),"%",")"), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,.(Collaborations = toString(inst_with_share)), Leiden1]

most_prod_countries <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_countries <- merge(most_prod_countries, Institutions[,.(ID_Art, Pays)], by = "ID_Art")
most_prod_countries <- most_prod_countries[Pays!="NULL"]
most_prod_countries <- most_prod_countries[,n_cit_count:=.N, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,n_tot_com:=.N, .(Leiden1)]
most_prod_countries <- most_prod_countries[,share:=n_cit_count/n_tot_com*100, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 1), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 5), Leiden1]
most_prod_countries <- most_prod_countries[,count_with_share := paste0(Pays,"(", round(share),"%",")"), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,.(Most_Productive_Countries = toString(count_with_share)), Leiden1]

summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_refs, most_cited_disc, most_prod_journal, most_prod_author, most_prod_institutions, most_prod_countries, collaborations))


pander(summary)

```


## Coupling `r names(tbl_coup_list[6])`

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
set.seed(2000)


tbl_list <- make_a_graph(tbl_coup_list[[6]], color, 1, "RBConfigurationVertexPartition", treshold_color=0.05, 0.02, layout_graph = "TRUE", 10000,2000)
tbl_list$components
tbl <- tbl_list$tbl

label_com <- tbl %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 1), Leiden1]

ggraph(tbl, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 
  # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm")

tbl_sec <- tbl_list$tbl_sec

label_com <- tbl_sec %>% activate(nodes) %>% as.data.table()
label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1]

ggraph(tbl_sec, "manual", x = x, y = y) +
  geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) +
  geom_node_point(aes(fill = color, size = size), pch=21) +
  scale_edge_width_continuous(range = c(0.5, 1)) +
  theme_void() +
  geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 0.1, fill = color)) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_edge_colour_identity() 

```

### tf-idf

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}
source("/home/alexandre/functions_networks.R")


tf_idf_results <- tf_idf(tbl, color, 10, 4)
tf_idf_results$plot


```

### Overview of Communities

```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'}

tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1]

most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1]

most_cited_refs <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_refs <- merge(most_cited_refs[,.(ID_Art, Leiden1)], refs[,.(ID_Art_Source, Label_Target, ItemID_Ref_Target)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_refs <- most_cited_refs[ItemID_Ref_Target!="NULL"]
most_cited_refs <- most_cited_refs[,n_cit_ref:=.N, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,n_tot_com:=.N, .(Leiden1)]
most_cited_refs <- most_cited_refs[,share:=n_cit_ref/n_tot_com*100, .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 1), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[order(-n_cit_ref), head(.SD, 5), Leiden1]
most_cited_refs <- most_cited_refs[,n_cit_ref_with_share := paste0(Label_Target,"(", round(share),"%",")"), .(Leiden1, ItemID_Ref_Target)]
most_cited_refs <- most_cited_refs[,.(Most_Cited_Refs = toString(n_cit_ref_with_share)), Leiden1]

most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table()
most_cited_disc <- merge(most_cited_disc, refs[,.(ID_Art_Source, ESpecialite_custom)], by.x = "ID_Art", by.y = "ID_Art_Source")
most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"]
most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)]
most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 1), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[order(-n_cit_disc), head(.SD, 5), Leiden1]
most_cited_disc <- most_cited_disc[,disc_with_share := paste0(ESpecialite_custom,"(", round(share),"%",")"), .(Leiden1, ESpecialite_custom)]
most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1]

most_prod_journal <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_journal <- most_prod_journal[,.N, .(Leiden1, Revue)][order(-N), head(.SD, 5), Leiden1][,  .(Most_Productive_Journals = toString(Revue)), Leiden1]

most_prod_author <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_author <- merge(most_prod_author, Authors[,.(ID_Art, Nom_ISI)], by = "ID_Art")
most_prod_author <- most_prod_author[,n_cit_aut:=.N, .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 1), .(Leiden1, Nom_ISI.y)]
most_prod_author <- most_prod_author[order(-n_cit_aut), head(.SD, 5), Leiden1]
most_prod_author <- most_prod_author[,.(Most_Productive_Authors = toString(Nom_ISI.y)), Leiden1]

most_prod_institutions <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_institutions <- merge(most_prod_institutions, Institutions[,.(ID_Art, Institution)], by = "ID_Art")
most_prod_institutions <- most_prod_institutions[Institution!="NULL"]
most_prod_institutions <- most_prod_institutions[,n_cit_inst:=.N, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,n_tot_com:=.N, .(Leiden1)]
most_prod_institutions <- most_prod_institutions[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 1), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[order(-n_cit_inst), head(.SD, 5), Leiden1]
most_prod_institutions <- most_prod_institutions[,inst_with_share := paste0(Institution,"(", round(share),"%",")"), .(Leiden1, Institution)]
most_prod_institutions <- most_prod_institutions[,.(Most_Productive_Institutions = toString(inst_with_share)), Leiden1]

collaborations <- tbl %>% activate(nodes) %>% as.data.table()
collaborations <- merge(collaborations, Institutions[,.(ID_Art, EU_US_collab)], by = "ID_Art")
collaborations <- collaborations[EU_US_collab!="NULL"]
collaborations <- collaborations[,n_cit_inst:=.N, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,n_tot_com:=.N, .(Leiden1)]
collaborations <- collaborations[,share:=n_cit_inst/n_tot_com*100, .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 1), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[order(-n_cit_inst), head(.SD, 5), Leiden1]
collaborations <- collaborations[,inst_with_share := paste0(EU_US_collab,"(", round(share),"%",")"), .(Leiden1, EU_US_collab)]
collaborations <- collaborations[,.(Collaborations = toString(inst_with_share)), Leiden1]

most_prod_countries <- tbl %>% activate(nodes) %>% as.data.table()
most_prod_countries <- merge(most_prod_countries, Institutions[,.(ID_Art, Pays)], by = "ID_Art")
most_prod_countries <- most_prod_countries[Pays!="NULL"]
most_prod_countries <- most_prod_countries[,n_cit_count:=.N, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,n_tot_com:=.N, .(Leiden1)]
most_prod_countries <- most_prod_countries[,share:=n_cit_count/n_tot_com*100, .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 1), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[order(-n_cit_count), head(.SD, 5), Leiden1]
most_prod_countries <- most_prod_countries[,count_with_share := paste0(Pays,"(", round(share),"%",")"), .(Leiden1, Pays)]
most_prod_countries <- most_prod_countries[,.(Most_Productive_Countries = toString(count_with_share)), Leiden1]

summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_refs, most_cited_disc, most_prod_journal, most_prod_author, most_prod_institutions, most_prod_countries, collaborations))


pander(summary)

```




<!-- ## Cocitation 1980 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->
<!-- tbl_list <- make_a_graph(tbl_cocit_80, color, 1, "RBConfigurationVertexPartition", treshold_color=0.1, 0, 10000,2000) -->
<!-- tbl_list$components -->
<!-- tbl <- tbl_list$tbl -->

<!-- label_com <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->
<!--   # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm") -->

<!-- tbl_sec <- tbl_list$tbl_sec -->

<!-- label_com <- tbl_sec %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl_sec, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->

<!-- ``` -->

<!-- ### tf-idf 1980 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->
<!-- tf_idf_results <- tf_idf(tbl, color, 10, 4) -->
<!-- tf_idf_results$plot -->


<!-- ``` -->

<!-- ### Overview of Communities -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->

<!-- tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1] -->

<!-- most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1] -->

<!-- most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"] -->
<!-- most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)] -->
<!-- most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 1), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 5), Leiden1] -->
<!-- most_cited_disc <- most_cited_disc[,disc_with_share := paste(ESpecialite_custom,"(", round(share),")"), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1] -->

<!-- most_cited_journals <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_journals <- most_cited_journals[is.na(Revue)==FALSE][,.N, .(Leiden1, Revue)][order(-N), head(.SD, 2), Leiden1][,  .(Most_Cited_Journals = toString(Revue)), Leiden1] -->

<!-- summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_disc, most_cited_journals)) -->

<!-- pander(summary) -->
<!-- ``` -->

<!-- ## Cocitation 1990 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->
<!-- tbl_list <- make_a_graph(tbl_cocit_90, color, 1, "RBConfigurationVertexPartition", treshold_color=0.1, 0, 10000,2000) -->
<!-- tbl_list$components -->
<!-- tbl <- tbl_list$tbl -->

<!-- label_com <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->
<!--   # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm") -->

<!-- tbl_sec <- tbl_list$tbl_sec -->

<!-- label_com <- tbl_sec %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl_sec, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->

<!-- ``` -->

<!-- ### tf-idf 1990 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->
<!-- tf_idf_results <- tf_idf(tbl, color, 10, 4) -->
<!-- tf_idf_results$plot -->


<!-- ``` -->

<!-- ### Overview of Communities -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->

<!-- tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1] -->

<!-- most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1] -->

<!-- most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"] -->
<!-- most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)] -->
<!-- most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 1), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 5), Leiden1] -->
<!-- most_cited_disc <- most_cited_disc[,disc_with_share := paste(ESpecialite_custom,"(", round(share),")"), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1] -->

<!-- most_cited_journals <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_journals <- most_cited_journals[is.na(Revue)==FALSE][,.N, .(Leiden1, Revue)][order(-N), head(.SD, 2), Leiden1][,  .(Most_Cited_Journals = toString(Revue)), Leiden1] -->

<!-- summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_disc, most_cited_journals)) -->

<!-- pander(summary) -->
<!-- ``` -->

<!-- ## Cocitation 2000 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->
<!-- tbl_list <- make_a_graph(tbl_cocit_00, color, 1, "RBConfigurationVertexPartition", treshold_color=0.1, 0, 10000,2000) -->
<!-- tbl_list$components -->
<!-- tbl <- tbl_list$tbl -->

<!-- label_com <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->
<!--   # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm") -->

<!-- tbl_sec <- tbl_list$tbl_sec -->

<!-- label_com <- tbl_sec %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl_sec, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->

<!-- ``` -->

<!-- ### tf-idf 2000 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->
<!-- tf_idf_results <- tf_idf(tbl, color, 10, 4) -->
<!-- tf_idf_results$plot -->


<!-- ``` -->

<!-- ### Overview of Communities -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->

<!-- tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1] -->

<!-- most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1] -->

<!-- most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"] -->
<!-- most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)] -->
<!-- most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 1), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 5), Leiden1] -->
<!-- most_cited_disc <- most_cited_disc[,disc_with_share := paste(ESpecialite_custom,"(", round(share),")"), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1] -->

<!-- most_cited_journals <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_journals <- most_cited_journals[is.na(Revue)==FALSE][,.N, .(Leiden1, Revue)][order(-N), head(.SD, 2), Leiden1][,  .(Most_Cited_Journals = toString(Revue)), Leiden1] -->

<!-- summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_disc, most_cited_journals)) -->

<!-- pander(summary) -->
<!-- ``` -->

<!-- ## Cocitation 2010 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->

<!-- tbl_list <- make_a_graph(tbl_cocit_10, color, 1, "RBConfigurationVertexPartition", treshold_color=0.1, 0, 10000,2000) -->
<!-- tbl_list$components -->
<!-- tbl <- tbl_list$tbl -->

<!-- label_com <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->
<!--   # ggsave("networks/coupling_kw.png", width=30, height=30, units = "cm") -->

<!-- tbl_sec <- tbl_list$tbl_sec -->

<!-- label_com <- tbl_sec %>% activate(nodes) %>% as.data.table() -->
<!-- label_com <- label_com[color!="#c0c0c0"][order(-size)][, head(.SD, 3), Leiden1] -->

<!-- ggraph(tbl_sec, "manual", x = x, y = y) + -->
<!--   geom_edge_arc(aes(color = color_edges, width = weight), alpha = 0.5, strength =0.2) + -->
<!--   geom_node_point(aes(fill = color, size = size), pch=21) + -->
<!--   scale_edge_width_continuous(range = c(0.5, 1)) + -->
<!--   theme_void() + -->
<!--   geom_label_repel(data = label_com, aes(x = x, y = y, label = as.character(Label), size = 10, fill = color)) + -->
<!--   theme(legend.position = "none") + -->
<!--   scale_fill_identity() + -->
<!--   scale_edge_colour_identity()  -->

<!-- ``` -->


<!-- ### tf-idf 2010 -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->
<!-- tf_idf_results <- tf_idf(tbl, color, 10, 4) -->
<!-- tf_idf_results$plot -->


<!-- ``` -->

<!-- ### Overview of Communities -->

<!-- ```{r echo=FALSE,  message=FALSE, warning=FALSE, error=FALSE, results=TRUE, out.width='100%'} -->

<!-- tfidf_table <- tf_idf_results$list_words[, .(tf_idf = toString(term)), Leiden1] -->

<!-- most_cited_nodes <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_nodes <- most_cited_nodes[order(-size), head(.SD, 5), Leiden1][,  .(Most_Cited_Nodes = toString(Label)), Leiden1] -->

<!-- most_cited_disc <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_disc <- most_cited_disc[ESpecialite_custom!="NULL"] -->
<!-- most_cited_disc <- most_cited_disc[,n_cit_disc:=.N, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,n_tot_com:=.N, .(Leiden1)] -->
<!-- most_cited_disc <- most_cited_disc[,share:=n_cit_disc/n_tot_com*100, .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 1), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[order(-share), head(.SD, 5), Leiden1] -->
<!-- most_cited_disc <- most_cited_disc[,disc_with_share := paste(ESpecialite_custom,"(", round(share),")"), .(Leiden1, ESpecialite_custom)] -->
<!-- most_cited_disc <- most_cited_disc[,.(Most_Cited_Disc = toString(disc_with_share)), Leiden1] -->

<!-- most_cited_journals <- tbl %>% activate(nodes) %>% as.data.table() -->
<!-- most_cited_journals <- most_cited_journals[is.na(Revue)==FALSE][,.N, .(Leiden1, Revue)][order(-N), head(.SD, 2), Leiden1][,  .(Most_Cited_Journals = toString(Revue)), Leiden1] -->

<!-- summary <- Reduce(merge, list(tfidf_table, most_cited_nodes, most_cited_disc, most_cited_journals)) -->

<!-- pander(summary) -->
<!-- ``` -->


```{r echo=FALSE, out.width='100%'}
# ## Get list of packages in the NLP/Machine Learning Task Views
# library(ctv)
# pkgs <- available.views()
# names(pkgs) <- sapply(pkgs, FUN=function(x) x$name)
# pkgs <- c(pkgs$NaturalLanguageProcessing$packagelist$name, pkgs$MachineLearning$packagelist$name)
# ## Get package descriptions of these packages
# library(tools)
# x <- CRAN_package_db()
# x <- x[, c("Package", "Title", "Description")]
# x$doc_id <- x$Package
# x$text   <- tolower(paste(x$Title, x$Description, sep = "\n"))
# x$text   <- gsub("'", "", x$text)
# x$text   <- gsub("<.+>", "", x$text)
# x        <- subset(x, Package %in% pkgs)
# 
# 
# 
# library(udpipe)
# library(data.table)
# library(stopwords)
# anno    <- udpipe(x, "english", trace = 10)
# biterms <- as.data.table(anno)
# biterms <- biterms[, cooccurrence(x = lemma,
#                                   relevant = upos %in% c("NOUN", "ADJ", "VERB") & 
#                                              nchar(lemma) > 2 & !lemma %in% stopwords("en"),
#                                   skipgram = 3),
#                    by = list(doc_id)]
# 
# 
# 
# library(BTM)
# set.seed(123456)
# traindata <- subset(anno, upos %in% c("NOUN", "ADJ", "VERB") & !lemma %in% stopwords("en") & nchar(lemma) > 2)
# traindata <- traindata[, c("doc_id", "lemma")]
# model     <- BTM(traindata, biterms = biterms, k = 9, iter = 2000, background = TRUE, trace = 100)
# 
# 
# library(textplot)
# library(ggraph)
# plot(model, top_n = 10,
#      title = "BTM model", subtitle = "R packages in the NLP/Machine Learning task views",
#      labels = c("Garbage", "Neural Nets / Deep Learning", "Topic modelling", 
#                 "Regression/Classification Trees/Forests", "Gradient Descent/Boosting", 
#                 "GLM/GAM/Penalised Models", "NLP / Tokenisation",
#                 "Text Mining Frameworks / API's", "Variable Selection in High Dimensions"))
```

```{python}

```